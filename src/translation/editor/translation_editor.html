<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translation Editor</title>
    <script src="./jquery-3.7.1.js"></script>
    <link href="./jquery-ui-1.14.1.dark/jquery-ui.css" rel="stylesheet">
    <script src="./jquery-ui-1.14.1.dark/jquery-ui.js"> </script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
        body {
            background-color: #333;
            color: #fff;
        }
    </style>
</head>
<body>
    <h1>Translation Editor</h1>
    <h2>Languages</h2>
    <div id="tabs">
        <ul id="tab_labels"></ul>
   </div>

    <script>
        const known_translations = ['pl-pl', 'bs-ba', 'it-it', 'zh-cn'];
        loaded_data = {}; // intentionally global

        function load_data(id, path) {
            // returns a promise
            let promise = $.ajax({
                url: path,
                dataType: 'json'
            });
            promise.done(function(data) {
                loaded_data[id] = data;
            }).fail(function(jqXHR, textStatus, errorThrown) {
                alert(`Failed to load data ${id} from ${path}: ` + textStatus + ' - ' + errorThrown);
            });
            return promise;
        }
       
        function load_data_to_table(translation_id, tbody) {
            var en_us = loaded_data['en-us'];
            var translated = loaded_data[translation_id];
                
            tbody.empty(); // Clear existing rows
            $.each(en_us, function(id, en_row) {
                let value = translated[id] || {};
                const localized = value.Localized || '';
                const en_us_value = value.EN_US || '';
                const current_en_us_value = en_row.Localized;
                const is_old = !(en_us_value == current_en_us_value);

                var $row = $('<tr>');
                $row.append($('<td>').append($('<input>').attr('type', 'checkbox').prop('checked', is_old)));
                $row.append($('<td>').text(id));
                $row.append($('<td>').append($('<input>').attr('type', 'text').val(localized)));
                $row.append($('<td>').text(current_en_us_value));
                tbody.append($row);
            });
        }

        function add_table_structure(table) {
            table.append($('<thead>').append(
                $('<tr>')
                .append($('<th>').text('Old'))
                .append($('<th>').text('ID'))
                .append($('<th>').text('Localized'))
                .append($('<th>').text('EN_US'))
            ));
        }


        function convert_row_data_to_object(translation_id, row) {
            const is_old = row.find('td:nth-child(1) input').prop('checked');
            const id = row.find('td:nth-child(2)').text();
            const localized = row.find('td:nth-child(3) input').val().trim();
            const current_en_us_base = row.find('td:nth-child(4)').text();
            const comments = row.find('td:nth-child(5) input').val();
            const as_loaded = loaded_data[translation_id][id];

            // is the information different from what was loaded?
            // only editable field is Localized
            let should_save = false;
            if (localized != as_loaded.Localized) {
                should_save = true;
            }
            // but, also want to update the tracked EN_US string when....
            // * `is_old` was set when originally loaded
            //   (e.g., as_loaded.EN_US != current_en_us_base)
            //   AND 
            // * `is_old` checkbox was cleared by the user
            //   which indicates they want to keep the translation
            //   (including when it's an empty string)
            if ((as_loaded.EN_US != current_en_us_base) &&is_old !) {
                should_save = true;
            }

            if (!should_save) {
                return null;
            }
            return { 
                'ID': id,
                'Localized': localized === '' ? null : localized,
                'EN_US': current_en_us_base,
                'Comments': as_loaded.Comments
            };
        }


        function get_export_data(translation_id) {
            var en_us_data = loaded_data['en-us'];
            var original_data = loaded_data[translation_id];
            var result = {};
            en_us_data.each(function(id, en_row) {
                var $row = $(`#translation-${translation_id} tr`).filter(function() {
                    return $(this).find('td:nth-child(2)').text() === id;
                });
                if ($row.length > 0) {
                    var row_as_object = convert_row_data_to_object(translation_id, $row);
                    if (row_as_object) {
                        result[id] = row_as_object;
                    }
                }
            });
            return result;

        }


        $(document).ready(function() {

            let promises_of_loaded_data = [];
            
            promises_of_loaded_data.push( load_data('en-us', `../history/en-us.json`) );
            $.each(known_translations, function(index, value) {
                promises_of_loaded_data.push( load_data(value, `../templates/${value}.json`) );
            });
            console.log("Promises of loaded data: ", promises_of_loaded_data);

            // wait for all the data to be loaded...
            $.when(...promises_of_loaded_data).done(function() {
                console.log("Loaded all data: ", loaded_data);

                $.each(promises_of_loaded_data, function(index, value) {
                    console.log(`Loaded data: ${value}`);
                    loaded_data[value.responseJSON.language] = value.responseJSON.data;
                });

                $.each(known_translations, function(index, value) {
                    let $section = `tabs-${value}`;
                    $('#tab_labels').append($('<li>').append($('<a>').attr('href', "#" + $section).text(value.toUpperCase())));
                    $('#tabs').append($('<div>').attr('id', $section));
                    let $tabdata = $(`#${$section}`);
                    let $table = $('<table>').attr('id', `translation-${value}`);
                    add_table_structure($table);
                    $tabdata.append($table);
                    load_data_to_table(value, $table);
                });
                $('#tab_labels').append($('<li>').append($('<a>').attr('href', "#tabs-new").text('New')));
                $('#tabs').append($('<div>').attr('id', 'tabs-new'));
                let $tabdata = $('#tabs-new');
                let $table = $('<table>').attr('id', 'translation-new');
                add_table_structure($table);
                load_data_to_table('en-us', $table);
                // set the text for each row to be empty string
                $table.find('input[type="text"]').val('');
                $table.find('input[type="checkbox"]').prop('checked', true);
                $tabdata.append($table)

                $( "#tabs" ).tabs();

            }).fail(function(jqXHR, textStatus, errorThrown) {
                alert('Failed to load data: ' + textStatus + ' - ' + errorThrown);
            });

        });



    </script>
</body>
</html>