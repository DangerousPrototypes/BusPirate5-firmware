<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translation Editor</title>
    <script src="./jquery-3.7.1.js"></script>
    <link href="./jquery-ui-1.14.1.dark/jquery-ui.css" rel="stylesheet">
    <script src="./jquery-ui-1.14.1.dark/jquery-ui.js"> </script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
        body {
            background-color: #333;
            color: #fff;
        }
    </style>
</head>
<body>
    <h1>Translation Editor</h1>
    <h2>Languages</h2>
    <div id="tabs">
        <ul id="tab_labels"></ul>
   </div>

    <script>
        // TODO:
        // * [ ] Create a new translation (all empty, but based on current en_us)
        // * [ ] Enable word-wrap for localized and en-us columns
        // * [ ] Detect when any row's value was changed for a translation
        // * [ ] add filters to datagrid
        //   * [ ] Filter by "old" checkbox
        //   * [ ] Filter ID
        // * [ ] Mark rows that no longer exist in en-us with error marker
        // * [ ] Mark rows having different format specifiers with error marker
        // * [ ] For outdated rows, show the old en_us value as a tooltip?
        // * [ ] automatically update list of known translations?
        //
        // * [ ] SAVE THE CURRENT TRANSLATION DATA TO OUTPUT TAB (w/a copy to clipboard button?)

        const known_translations = ['pl-pl', 'bs-ba', 'it-it', 'zh-cn'];
        
        function select_translation() {
            var filename = document.getElementById("language_selection").value;
            if (known_translations.includes(filename)) {
                return filename + '.json';
            } else {
                alert('Invalid file name. Please enter one of the following: \n    ' + known_translations.join('\n    '));
                return null;
            }
        }

        $('#loadDataButton').on('click', function() {
            filename = select_translation();
            if (filename) {
                var $tbody = $('#translationTable tbody');
                loadData(filename, $tbody);
            }
        });

        function loadData(filename, tbody) {
            $.when(
                $.getJSON('../history/en-us.json'),
                $.getJSON(`../templates/${filename}`)
            ).done(function(enUsData, translated_data) {
                var enUs = enUsData[0];
                var translated = translated_data[0];
                
                tbody.empty(); // Clear existing rows
                $.each(translated, function(id, value) {
                    var localized = value.Localized || '';
                    var enUsValue = value.EN_US || '';
                    var currentEnUsValue = enUs[id] ? enUs[id].Localized : '';
                    var comments = value.Comments || '';
                    var isOld = !(enUsValue == currentEnUsValue);

                    var $row = $('<tr>');
                    $row.append($('<td>').append($('<input>').attr('type', 'checkbox').prop('checked', isOld)));
                    $row.append($('<td>').text(id));
                    $row.append($('<td>').append($('<input>').attr('type', 'text').val(localized)));
                    $row.append($('<td>').text(currentEnUsValue));
                    $row.append($('<td>').append($('<input>').attr('type', 'text').val(comments)));
                    tbody.append($row);
                });
            }).fail(function(jqXHR, textStatus, errorThrown) {
                alert('Failed to load data: ' + textStatus + ' - ' + errorThrown);
            });
        }

        function add_table_structure(table) {
            table.append($('<thead>').append(
                $('<tr>')
                .append($('<th>').text('Old'))
                .append($('<th>').text('ID'))
                .append($('<th>').text('Localized'))
                .append($('<th>').text('EN_US'))
                .append($('<th>').text('Comments'))
            ));
        }

        $(function() {
        });
        $(document).ready(function() {
            $.each(known_translations, function(index, value) {
                $section = `tabs-${value}`;
                $('#tab_labels').append($('<li>').append($('<a>').attr('href', "#" + $section).text(value.toUpperCase())));
                $('#tabs').append($('<div>').attr('id', $section));
                $tabdata = $(`#${$section}`);
                $table = $('<table>').attr('id', `translation-${value}`);
                add_table_structure($table);
                $tabdata.append($table);
                loadData(`${value}.json`, $table);

                
            });

            $( "#tabs" ).tabs();

        });
    </script>
</body>
</html>